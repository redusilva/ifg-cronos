import hashlib
from virus_total_apis import PublicApi
from flask import Flask, request

app = Flask(__name__)

@app.route("/api/check", methods=["POST"])
def check_file():
    try:
        file = request.files["file"]
        en_hash = hashlib.md5(file.read()).hexdigest()

        api_key = "62e7ba1ff4a091a4c36715027f83dba3ec5873f3d3f88f28a9072cded49a84a2"
        api = PublicApi(api_key)
        result = api.get_file_report(en_hash)

        app.logger.info(f"API Response: {result}")

        if result.get("response_code") == 200:
            positives = result.get("results", {}).get("positives", 0)
            if positives > 0:
                return {"valid": False}
            else:
                return {"valid": True}
        else:
            raise ValueError(result.get("message", "Unknown error"))

    except KeyError as e:
        app.logger.error(f"KeyError: {e}")
        return {"error": "KeyError occurred"}
    except Exception as e:
        app.logger.error(f"An unexpected error occurred: {e}")
        return {"error": "Unexpected error"}

if __name__ == "__main__":
    app.run(debug=True)
