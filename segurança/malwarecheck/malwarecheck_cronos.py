import hashlib
from virus_total_apis import PublicApi

from flask import Flask, request

app = Flask(__name__)

@app.route("/api/check", methods=["POST"])
def check_file():

  # Obtém o arquivo do request.
  file = request.files["file"]

  # Calcula o hash do arquivo.
  en_hash = hashlib.md5(file.read()).hexdigest()

  # Consulta o VirusTotal para verificar se o arquivo é malicioso.
  api = PublicApi("6004e2c2cfecc21f4ada50c445c63268ce5c52563fb06295f8530bf4bb005ce5")
  result = api.get_file_report(en_hash)

  # Retorna se o arquivo é válido.
  if result["response_code"] == 200:
    if result["results"]["positives"] > 0:
      return {"valid": False}
    else:
      return {"valid": True}
  else:
    raise ValueError(result["message"])

if __name__ == "__main__":
  app.run(debug=True)
