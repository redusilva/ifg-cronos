import hashlib
from virus_total_apis import PublicApi
from flask import Flask, request

app = Flask(__name__)

@app.route("/api/check", methods=["POST"])
def check_file():
    try:
        file = request.files["file"]
        if not file:
            raise ValueError("Nenhum arquivo enviado")

        # Calcula o hash do arquivo.
        en_hash = hashlib.md5(file.read()).hexdigest()

        # Consulta o VirusTotal para verificar se o arquivo é malicioso.
        api_key = "SuaChaveAqui"  # Substitua pela sua chave real ou configure como uma variável de ambiente
        api = PublicApi(api_key)
        result = api.get_file_report(en_hash)

        # Retorna se o arquivo é válido.
        if result["response_code"] == 200:
            # Verifica se a chave "positives" está presente nos resultados antes de acessá-la.
            positives = result["results"].get("positives", 0)

            if positives > 0:
                return {"valid": False}
            else:
                return {"valid": True}
        else:
            raise ValueError(result["message"])

    except Exception as e:
        return {"error": str(e)}

if __name__ == "__main__":
    app.run(debug=True)
